# GITHUB_TOKEN is required to be set to read/write permissions (default seems to be read only): https://github.com/TheOddler/github-actions-tests/settings/actions

# Requires branch to be protected: https://github.com/TheOddler/github-actions-tests/settings/branches
# How protected doesn't really matter I think.

name: Disable merging

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      duration:
        description: How long to disable merging. Suffix may be 's' for seconds (the default), 'm' for minutes, 'h' for hours or 'd' for days.
        default: '3h'
        required: true
      branch:
        description: What branch to protect
        default: main
        required: true

jobs:
  disable-merging:
    name: Disable Merging
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
    - name: Enforce the admin protection
      run: |
        curl --fail-with-body -L \
          -X PATCH \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.MY_PAT }}"\
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/${{ github.repository }}/branches/${{ github.event.inputs.branch }}/protection \
          -d '{"lock_branch":true}'
    
  wait:
    name: Wait
    needs: disable-merging
    runs-on: ubuntu-latest
    steps:
    - name: Wait the allotted time
      uses: jakejarvis/wait-action@master
      with:
        time: '${{ github.event.inputs.duration }}'

  reenable-merging:
    name: Reenable Merging
    needs: wait
    if: always() # Run this even if "wait" fails or is cancelled
    runs-on: ubuntu-latest
    steps:
    - name: Remove the admin protection
      run: |
        curl --fail-with-body -L \
          -X PATCH \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.MY_PAT }}"\
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/${{ github.repository }}/branches/${{ github.event.inputs.branch }}/protection/required_pull_request_reviews \
          -d '{"require_code_owner_reviews":false}'
