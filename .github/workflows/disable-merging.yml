# GITHUB_TOKEN is required to be set to read/write permissions (default seems to be read only): https://github.com/TheOddler/github-actions-tests/settings/actions

# Requires branch to be protected: https://github.com/TheOddler/github-actions-tests/settings/branches
# How protected doesn't really matter I think.

name: Disable merging

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      duration:
        description: How long to disable merging. Suffix may be 's' for seconds (the default), 'm' for minutes, 'h' for hours or 'd' for days.
        default: '3h'
        required: true
      branch:
        description: What branch to protect
        default: main
        required: true

jobs:
  disable-merging:
    name: Disable Merging
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
    - name: Enforce the admin protection
    #   uses: octokit/request-action@v2.1.0
    #   id: remove_admin_protection
    #   with:
    #     route: POST /repos/{owner}/{repo}/branches/{branch}/protection/enforce_admins
    #     owner: TheOddler
    #     repo: github-actions-tests
    #     branch: ${{ github.event.inputs.branch }}
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.MY_PAT }}
      run: |
        curl --fail-with-body -L \
          -X PUT \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.MY_PAT }}"\
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/${{ github.repository }}/branches/${{ github.event.inputs.branch }}/protection \
          -d @- <<'EOF'
            {
              "required_status_checks": {
                "strict": true,
                "contexts": []
              },
              "enforce_admins": true,
              "required_pull_request_reviews": {
                "required_approving_review_count": 1
              },
              "restrictions": {
                "users": [],
                "teams": []
              },
              "allow_force_pushes": false,
              "allow_deletions": false,
              "lock_branch": true
            }
          EOF
    # -d '{"required_status_checks":{"strict":true,"contexts":[]},"enforce_admins":true,"required_pull_request_reviews":{"dismissal_restrictions":{"users":["octocat"],"teams":["justice-league"]},"dismiss_stale_reviews":true,"require_code_owner_reviews":true,"required_approving_review_count":2,"require_last_push_approval":true,"bypass_pull_request_allowances":{"users":["octocat"],"teams":["justice-league"]}},"restrictions":{"users":["octocat"],"teams":["justice-league"],"apps":["super-ci"]},"required_linear_history":true,"allow_force_pushes":true,"allow_deletions":true,"block_creations":true,"required_conversation_resolution":true,"lock_branch":true,"allow_fork_syncing":true}'
    
  wait:
    name: Wait
    needs: disable-merging
    runs-on: ubuntu-latest
    steps:
    - name: Wait the allotted time
      uses: jakejarvis/wait-action@master
      with:
        time: '${{ github.event.inputs.duration }}'

  reenable-merging:
    name: Reenable Merging
    needs: wait
    runs-on: ubuntu-latest
    steps:
    - name: Remove the admin protection
      uses: octokit/request-action@v2.1.0
      id: remove_admin_protection
      with:
        route: DELETE /repos/{owner}/{repo}/branches/{branch}/protection/enforce_admins
        owner: TheOddler
        repo: github-actions-tests
        branch: ${{ github.event.inputs.branch }}
      env:
        GITHUB_TOKEN: ${{ secrets.MY_PAT }}
