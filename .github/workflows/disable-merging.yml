name: Disable merging

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      duration:
        description: How long to disable merging. Suffix may be 's' for seconds (the default), 'm' for minutes, 'h' for hours or 'd' for days.
        default: '3h'
        required: true

jobs:
  disable-merging:
    runs-on: ubuntu-latest

    steps:
    - uses: octokit/request-action@v2.x
      id: create_check_run
      with:
        name: Enforce admin protection for master branch
        route: POST /repos/{owner}/{repo}/branches/{branch}/protection/enforce_admins
        owner: ${{ github.event.repository.owner }}
        repo: ${{ github.event.repository.name }}
        branch: ${{ github.event.workflow_run.head_branch }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Wait the allotted time
      uses: jakejarvis/wait-action@master
      with:
        time: '${{ github.event.inputs.duration }}'

    - uses: octokit/request-action@v2.x
      id: create_check_run
      with:
        name: Removed the admin protection for master branch
        route: DELETE /repos/{owner}/{repo}/branches/{branch}/protection/enforce_admins
        owner: ${{ github.event.repository.owner }}
        repo: ${{ github.event.repository.name }}
        branch: ${{ github.event.workflow_run.head_branch }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
